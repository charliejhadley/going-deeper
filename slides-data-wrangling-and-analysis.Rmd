---
title: "Advanced Data Wrangling and Analysis"
subtitle: "Going Deeper with R"
output:
  xaringan::moon_reader:
    css: ["style.css", "default"]
    lib_dir: libs
    df_print: paged
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: 16:9
---

```{r child = "setup.Rmd"}
```

```{r eval = TRUE, echo = FALSE}
library(tidyverse)
library(readxl)
library(janitor)
```


class: center, middle, dk-section-title

background-image:url("images/data.jpg")

# Importing Data

---

## Downloading Data Directly

The `download.file()` function lets us download files directly from websites.

```{r eval = FALSE}
download.file(url, destfile = "data-raw/name-of-file.xlsx")
```

???

Benefit = reproducibility

---

## Importing Excel Files

.center[
![](images/readxl-logo.png)
]

---

## Importing Excel Files

```{r eval = FALSE}
data_frame <- read_excel(path = "directory_name/file_name.xlsx",
                         sheet = "name of sheet")
```

---

## Importing Excel Files


```{r eval = TRUE}
german_speakers <- read_excel(path = "data-raw/German and French Speakers.xlsx",
                              sheet = "German speakers") %>% 
  clean_names()
```

--

```{r eval = TRUE, echo = FALSE}
german_speakers
```



---


## Other Packages for Importing Data

.pull-left[
Got SAS, Stata, or SPSS data? Use the [haven package](https://haven.tidyverse.org/).
]

.pull-right[
.center[
![](images/haven-logo.png)
]
]

---

## Other Packages for Importing Data

.pull-left[
The [rio package](https://github.com/leeper/rio) makes it as simple as possible to import and export data. 

You give it the location of the data file in the `import()` function and it auto-detects the file type. 
]

.pull-right[
.center[
![](images/rio-logo.png)
]
]

---

class: my-turn

## My Turn

I'll create a new project. 

Throughout, I'll be working with the following data: 

- [State of Oregon 2018-2019 school attendance data](https://www.oregon.gov/ode/reports-and-data-raw/students/Documents/fallmembershipreport_20182019.xlsx)

- [State of Oregon 2018-2019 3rd grade math proficiency data](https://www.oregon.gov/ode/reports-and-data-raw/students/Documents/regularattenders_report_1819.xlsx)


---

class: my-turn

## My Turn (continued)

I'll do the following:

1. Create a new R script file where I'll do all of my data prep work

--

1. Download the two files above manually and put them in the data folder

--

1. Download the two files above using the download.file() function (in the process, I'll overwrite the files I downloaded before)

--

1. Import the data into two data frames (`math_scores` and `attendance`)

--

I'm ultimately going to compare third grade math scores and rates of chronic absenteeism.

---

class: inverse

## Your Turn

Create a new project. Make sure you put it somehwere you'll be able to find it again later!

--

You'll be working with the following data:

- [State of Oregon 3rd grade 2018-2019 enrollment data](https://www.oregon.gov/ode/reports-and-data-raw/students/Documents/fallmembershipreport_20182019.xlsx)

- [State of Oregon 3rd grade 2018-2019 reading proficiency data](https://www.oregon.gov/ode/educator-resources/assessment/Documents/TestResults2019/pagr_Districts_ELA_1819.xlsx)

---

class: inverse

## Your Turn (continued)


Do the following:

1. Create a new R script file where you'll do all of your data prep work

--

1. Download the two files above using the download.file() function

--

1. Import the data into two data frames (`enrollment` and `reading_scores`)


---

class: center, middle, dk-section-title

background-image:url("images/berries.jpg")

# Tidy Data

---

## Untidy Data


```{r eval = TRUE, echo = FALSE}
german_speakers_numeric <- read_excel(path = "data-raw/German and French Speakers.xlsx",
                              sheet = "German speakers",
                              na = "-") %>% 
  clean_names()
```

--

```{r eval = TRUE}
german_speakers_numeric
```

---

## Untidy Data

--

```{r eval = TRUE}
german_speakers_numeric %>% 
  group_by(state) %>% 
  mutate(total = number_of_german_speakers_2017 + number_of_german_speakers_2018 + number_of_german_speakers_2019) %>% 
  select(state, total)
```

???

But what if we have 10 or 20 years of data? Are we going to write out a all of those years individually?



---

## Tidy Data


```{r eval = TRUE, echo = FALSE}
german_speakers_tidy <- german_speakers %>% 
  pivot_longer(-state) %>% 
  mutate(year = parse_number(name)) %>% 
  mutate(number = parse_number(value)) %>% 
  select(state, year, number)
```

```{r eval = TRUE}
german_speakers_tidy
```

---

## Tidy Data


```{r eval = TRUE}
german_speakers_tidy %>% 
  group_by(state) %>% 
  summarize(total = sum(number))
```


???

The tidyverse wants data in a certain format: tidy. With data in this format, it becomes much easier to work with. 

---

## The Three Rules of Tidy Data

--

1. Each variable forms a column.

--

2. Each observation forms a row.

--

3. Each type of observational unit forms a table.

--

*We'll focus on #1 and #3. To read about examples of untidy data, check out the [Tidy Data vignette](https://tidyr.tidyverse.org/articles/tidy-data.html).*

---

class: my-turn

## My Turn

Let's take a look at my data and see which principles of tidy data it violates


---

class: inverse

## Your Turn

--

1. Read the [Tidy Data vignette](https://tidyr.tidyverse.org/articles/tidy-data.html)

--

1. Take a look at your data and see which principles of tidy data it violates

---

class: center, middle, dk-section-title

background-image:url("images/shape.jpg")

# Reshaping Data

---

## Reshaping Data: `pivot_longer()`

The `pivot_longer()` function helps us in situations where column headers are values, not variable names.

--

```{r eval = FALSE}
data_frame %>% 
  pivot_longer(cols = columns_to_use) #<<
```

--

```{r eval = FALSE}
data_frame %>% 
  pivot_longer(cols = columns_to_use,
               names_to = "name_of_identifer_variable") #<<
```

--

```{r eval = FALSE}
data_frame %>% 
  pivot_longer(cols = columns_to_use,
               names_to = "name_of_identifer_variable",
               values_to = "name_of_value_variable") #<<
```


---

## Reshaping Data: `pivot_longer()`

```{r eval = TRUE, echo = FALSE}
german_speakers
```

---

## Reshaping Data: `pivot_longer()`

```{r pivot_longer_example}
german_speakers %>% 
  pivot_longer(cols = -state)
```

--

```{r ref.label = "pivot_longer_example", eval = TRUE, echo = FALSE}
```


---

## Reshaping Data: `pivot_longer()`

```{r eval = TRUE}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", #<<
               values_to = "number") #<<
```

---

## Reshaping Data: `pivot_wider()`

```{r eval = TRUE}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year",
               values_to = "number") %>% 
  pivot_wider(names_from = "state", #<<
              values_from = "number") #<<
```

???

I mostly use it to present data in tables

---

class: my-turn

## My Turn

I'll do the following to create a new data frame called `math_percent_not_proficient`: 

--

1. Use `filter()` to only keep rows where the `student_group` variable is "Total Population (All Students)"

--

1. Use `filter()` to only keep third grade students

--

1. Use `select()` to only keep variables related to percent of students who are proficient

--

1. Use `pivot_longer()` to make my data frame tidy

---

class: inverse

## Your Turn

Do the following to create a new data frame called `enrollment_by_race`: 

--

1. select() the variables from county to district as well as all variables about grade (hint: use the [`contains()` helper function](https://dplyr.tidyverse.org/reference/select.html#useful-functions) within `select()`)

--

1. Use `pivot_longer()` to convert all of the grade variables into one variable

--

1. Within `pivot_longer()`, use the names_to argument to call that variable `race_ethnicity`

--

1. Within `pivot_longer()`, use the values_to argument to call that variable `number_of_students`


---

class: center, middle, dk-section-title

background-image:url("images/missing.jpg")

# Dealing with Missing Data

---

## Dealing with Missing Data: `na_if()`

```{r eval = TRUE}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number")
```

---

## Dealing with Missing Data: `na_if()`

```{r}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) #<<
```

---

## Dealing with Missing Data: `na_if()`

```{r eval = TRUE}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) #<<
```


???

The `na_if()` function turns values that represent missing data into actual NAs

You can also do this with na arguments in read_excel etc

---

## Dealing with Missing Data: `replace_na()`


```{r eval = TRUE}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) #<<
```

???

The `replace_na()` function does the opposite: turns NAs into values.


---

class: my-turn

## My Turn

1. Convert all of the missing values (they should show up as "-") in the `percent_proficient` variable to NA using `na_if()`

*I don't have any values where using `replace_na()` makes sense, but you'll use it shortly!*

---

class: inverse

## Your Turn

--

1. Convert all of the missing values (they should show up as "-") in the `number_of_students` variable to NA using `na_if()`

--

1. Convert all of the NA values you just made to 0 using `replace_na()`.

---

class: center, middle, dk-section-title

background-image:url("images/types.jpg")

# Changing Variable Types

---

## Changing Variable Types

```{r}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  summarize(total = sum(number))
```

--

<p class="error-text">Error in sum(number) : invalid 'type' (character) of argument</p>

---

## Changing Variable Types

To change variable types, you use the `mutate()` function combined with `as.numeric()`, `as.character()`, etc.

```{r eval = TRUE}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% #<<
  summarize(total = sum(number))
```


---

class: my-turn

## My Turn

Convert the `percent_proficient` variable to numeric by using `as.numeric()`

---

class: inverse

## Your Turn

--

1. Convert the `number_of_students` variable to numeric by using `as.numeric()`

--

1. Use `mutate()` to calculate a new variable called `pct` that is the percent of the total enrollment for students in each race/ethnicity group



---

class: center, middle, dk-section-title

background-image:url("images/throwing-pot.jpg")

# Advanced Variable Creation

---

## `recode()`

```{r}
data_frame %>% 
  mutate(var = recode(variable, "old_value" = "new_value"))
```

---

## `recode()`


```{r recode-example}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% 
  mutate(year = recode(year, 
                       "2017-number-of-german-speakers" = "2017", #<<
                       "2018-number-of-german-speakers" = "2018", #<<
                       "2019-number-of-german-speakers" = "2019")) #<<
```

---

## `recode()`

```{r ref.label = "recode-example", eval = TRUE, echo = FALSE}
```

---

## `if_else()`

```{r}
data_frame %>% 
  mutate(var = if_else(variable == "some_value", "if_true_value" = "else_value"))
```

---

## `if_else()`

```{r if_else-example}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% 
  mutate(year = if_else(year == "2017-number-of-german-speakers", "2017", year)) %>% #<<
  mutate(year = if_else(year == "2018-number-of-german-speakers", "2018", year)) %>% #<<
  mutate(year = if_else(year == "2019-number-of-german-speakers", "2019", year)) #<<

```

---

## `if_else()`

```{r ref.label = "if_else-example", eval = TRUE, echo = FALSE}

```


---

## `case_when()`

```{r}
data_frame %>% 
  mutate(var = case_when(
    variable == "some_value" ~ "new_value",
    variable == "some_other_value" ~ "new_value_2",
    variable == "some_third_value" ~ "new_value_3",
    TRUE ~ "value_for_all_observations_that_dont_match_any_above_criteria"
  ))
```

---



## `case_when()`

```{r case_when-example}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% 
  mutate(year = case_when( #<<
    year == "2017-number-of-german-speakers" ~ "2017", #<<
    year == "2018-number-of-german-speakers" ~ "2018", #<<
    year == "2019-number-of-german-speakers" ~ "2019" #<<
  )) #<<

```

---

## `case_when()`

```{r ref.label = "case_when-example", eval = TRUE, echo = FALSE}

```

---

## More complicated `case_when()`

```{r case_when-complicated-example}
german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% 
  mutate(number_categorical = case_when( #<<
    number < 500 ~ "Less than 500", #<<
    between(number, 500, 1000) ~ "Between 500 and 1000", #<<
    number > 1000 ~ "Greater than 1000" #<<
  )) #<<

```

---

## More complicated `case_when()`

```{r ref.label = "case_when-complicated-example", eval = TRUE, echo = FALSE}

```


---

class: my-turn

## My Turn

I'll convert all instances of the `proficiency_level` variable to more meaningful observations using: 

1. `recode()`

2. `if_else()`

3. `case_when()`

---

class: inverse

## Your Turn

Convert all instances of the `race_ethnicity` variable to more meaningful observations (e.g. turn "x2018_19_asian" into "Asian") using any of the follwoing:

1. `recode()`

2. `if_else()`

3. `case_when()`

---

class: center, middle, dk-section-title

background-image:url("images/highway.jpg")

# Data Merging

---

## Data Merging

All of the animations and explanations used here come from the [tidyexplain project by Garrick Aden-Buie](https://www.garrickadenbuie.com/project/tidyexplain/).


---

## Data Merging

```{r eval = TRUE}
german_speakers_2019 <- german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% 
  mutate(year = parse_number(year)) %>% 
  filter(year == 2019) %>% 
  select(-year)
```


---

## Data Merging

```{r}
german_speakers_2019 <- german_speakers %>% 
  pivot_longer(cols = -state,
               names_to = "year", 
               values_to = "number") %>% 
  mutate(number = na_if(number, "-")) %>% 
  mutate(number = replace_na(number, 0)) %>% 
  mutate(number = as.numeric(number)) %>% 
  mutate(year = parse_number(year)) %>% #<<
  filter(year == 2019) %>% 
  select(-year)
```

---

class: center

![](images/parse_number.png)

Image courtesy of [Allison Horst](https://github.com/allisonhorst/stats-illustrations)




---

## Data Merging

```{r eval = TRUE}
german_speakers_2019

```





---

## Data Merging

```{r eval = TRUE, include = TRUE}
french_speakers_2019 <- read_excel(path = "data-raw/German and French Speakers.xlsx",
                              sheet = "French speakers 2019")
```

```{r eval = TRUE, echo = FALSE}
french_speakers_2019
```

---

## Joins

```{r}
type_of_join <- (x, y,
                 by = "id_variable")
```

--

What if we don't have a variable with the same name in both data frames?

--

```{r}
type_of_join <- (x, y,
                 by = c("id_variable_x" = "id_variable_y")
```

--

What if we need to join on multiple variables with different names in both data frames?

--

```{r}
type_of_join <- (x, y,
                 by = c("id_variable_a" = "id_variable_b",
                        "id_variable_c" = "id_variable_d")
```

???

I do left_join 95% of the time

https://twitter.com/ClausWilke/status/1235379667428835331?s=09

---

## Mutating joins

> A mutating join allows you to combine variables from two tables. It first matches observations by their keys, then copies across variables from one table to the other. - [R for Data Science](https://r4ds.had.co.nz/relational-data.html#mutating-joins)

---

### `left_join()`

All rows from x, and all columns from x and y. Rows in x with no match in y will have NA values in the new columns.

.center[
![](images/left-join.gif)
]



---

### `left_join()`

```{r eval = TRUE}
left_join(german_speakers_2019,
          french_speakers_2019,
          by = "state")
```

---

### `right_join()`

All rows from y, and all columns from x and y. Rows in y with no match in x will have NA values in the new columns.
.center[
![](images/right-join.gif)
]



---

### `right_join()`

```{r eval = TRUE}
right_join(german_speakers_2019,
           french_speakers_2019,
           by = "state")
```

---

### `full_join()`

All rows and all columns from both x and y. Where there are not matching values, returns NA for the one missing.
.center[
![](images/full-join.gif)
]

---

### `full_join()`

```{r eval = TRUE}
full_join(german_speakers_2019,
          french_speakers_2019,
          by = "state")
```


---

### `inner_join()`

All rows and all columns from both x and y. Where there are not matching values, returns NA for the one missing.
.center[
![](images/inner-join.gif)
]

---

### `inner_join()`

```{r eval = TRUE}
inner_join(german_speakers_2019,
           french_speakers_2019,
           by = "state")
```

---

## Filtering joins

> Filtering joins match observations in the same way as mutating joins, but affect the observations, not the variables - [R for Data Science](https://r4ds.had.co.nz/relational-data.html#filtering-joins)

---

### `semi_join()`

All rows from x where there are matching values in y, keeping just columns from x.
.center[
![](images/semi-join.gif)
]

---

### `semi_join()`

```{r eval = TRUE}
semi_join(german_speakers_2019,
          french_speakers_2019,
          by = "state")
```

---

### `anti_join()`

All rows from x where there are not matching values in y, keeping just columns from x.
.center[
![](images/anti-join.gif)
]

---

### `anti_join()`

```{r eval = TRUE}
anti_join(german_speakers_2019,
          french_speakers_2019,
          by = "state")
```

---

class: my-turn

## My Turn

1. Create a new data frame called `chronic_absenteeism` by starting with the attendance data frame and using the data wrangling skills we just learned

--

1. Calculate a new variable `percent_not_proficient` as the percentage of students at each school who are NOT at math proficiency levels 3 or 4 (i.e. are at levels 1 or 2)

--

1. Join the `math_percent_not_proficient` and `chronic_absenteeism` data frames to create a new data frame called `math_scores_chronic_absenteeism`




---

class: inverse

## Your Turn

Before doing your join, you'll need to create a new data frame called `reading_scores_by_race` by importing the reading scores data that you downloaded previously. Use the `read_excel()` function to do this.


---

class: inverse

## Your Turn (continued)

After you've imported your data, do the following:

  - Use the `clean_names()` function from the `janitor` package to give you nice variable names
  
--
  
  - `filter()` using the `grade_level` to only include "All Grades"

--

  - `filter()` using the `student_group` variable to only include the following groups ("American Indian/Alaskan Native", "Asian", "Black/African American", "Hispanic/Latino", "Multi-Racial", "Pacific Islander", or "White")

--

  - `select()` the following variables: `district_id`, `student_group`, `percent_proficient_level_3_or_4`

--

  - Divide the `percent_proficient_level_3_or_4` variable by 100 (you'll need to convert this variable to a numeric first to make this work)


---

class: inverse

## Your Turn (continued)

Create a new data frame called `enrollment_and_reading_scores_by_race` by mmerging the `enrollment_by_race` and `reading_scores_by_race` data frames using `left_join()`. 

You are joining on two separate things (district ID and race/ethnicity group), each of which has different names in the two data frames. You'll need to use the following format to do this matching on multiple columns.

```{r}
new_data_frame <- left_join(data_frame_1, data_frame_2,
                            by = ("variable_1" = "variable_2",
                                  "variable_3" = "variable_4"))
```


---

class: center, middle, dk-section-title

background-image:url("images/circle-pattern.jpg")

# Renaming Variables

---

## Renaming Variables

```{r eval = TRUE}
french_and_german_speakers_2019 <- left_join(german_speakers_2019,
                                             french_speakers_2019,
                                             by = "state")
```

```{r eval = TRUE, include = TRUE, echo = FALSE}
french_and_german_speakers_2019
```

---

## `rename()`

```{r}
data_frame %>% 
  rename("new_variable_name" = "old_variable_name")
```


---

## `rename()`

```{r rename_example}
french_and_german_speakers_2019 %>% 
  rename("german_speakers" = "number") #<<
```

--

```{r ref.label = "rename_example", eval = TRUE, echo = FALSE}
```

---

## `set_names()`

```{r set_names_example}
french_and_german_speakers_2019 %>% 
  set_names(c("state", "german_speakers", "french_speakers")) #<<
```

--

```{r ref.label = "set_names_example", eval = TRUE, echo = FALSE}
```


---

class: my-turn

## My Turn

I'll use `rename()` and/or `set_names()` to give the `math_scores_chronic_absenteeism` data frame more meaningful names.


---

class: inverse

## Your Turn

Use either `rename()` or `set_names()` to give the `enrollment_and_reading_scores_by_race` data frame more meaningful names. Make the following changes:

- Change `attending_district_institution_id` to `district_id`

- Change `x2018_19_total_enrollment` to `total_enrollment`

- Change `pct` to `percent_of_total_enrollment`

- Change `percent_proficient_level_3_or_4` to `reading_proficient_percent`


---

class: center, middle, dk-section-title

background-image:url("images/ship-export.jpg")

# Exporting Data

---

## `write_csv()`

```{r}
write_csv(french_and_german_speakers_2019,
          "data/french_and_german_speakers_2019.csv")
```

---

## `write_rds()`

```{r}
write_rds(french_and_german_speakers_2019,
          "data/french_and_german_speakers_2019.rds")
```


---

class: my-turn

## My Turn

--

1. Export my `math_scores_chronic_absenteeism` data frame as a CSV

--

1. Export my `math_scores_chronic_absenteeism` data frame as an RDS file


---

class: inverse

## Your Turn

1. Export the `enrollment_and_reading_scores_by_race` data frame as an RDS file in the data directory (you'll need to make this directory)

